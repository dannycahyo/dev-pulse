version: 2

models:
  - name: dim_date
    description: "Calendar dimension table generated from a date spine (2020-01-01 to CURRENT_DATE + 365 days). Provides day, week, month, quarter, and year attributes for joining with fact tables."
    columns:
      - name: date_key
        description: "Surrogate key in YYYYMMDD integer format"
        tests:
          - unique
          - not_null
      - name: full_date
        description: "Calendar date value"
        tests:
          - unique
          - not_null
      - name: day_of_week
        description: "Day of week (1=Sunday, 7=Saturday)"
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7]
      - name: day_name
        description: "Full name of the day (e.g., Monday, Tuesday)"
        tests:
          - not_null
      - name: day_of_month
        description: "Day of the month (1-31)"
        tests:
          - not_null
      - name: iso_week_number
        description: "ISO week number of the year (1-53)"
        tests:
          - not_null
      - name: month_number
        description: "Month number (1-12)"
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
      - name: month_name
        description: "Full name of the month (e.g., January, February)"
        tests:
          - not_null
      - name: quarter
        description: "Quarter of the year (1-4)"
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4]
      - name: year
        description: "Calendar year"
        tests:
          - not_null
      - name: is_weekend
        description: "Boolean flag indicating whether the date falls on a weekend (Saturday or Sunday)"
        tests:
          - not_null

  - name: dim_repository
    description: "Repository dimension containing GitHub repository metadata. Uses FARM_FINGERPRINT on repo_full_name as surrogate key."
    columns:
      - name: repo_id
        description: "Surrogate key generated via FARM_FINGERPRINT(repo_full_name)"
        tests:
          - unique
          - not_null
      - name: repo_name
        description: "Short repository name"
        tests:
          - not_null
      - name: repo_full_name
        description: "Full repository name in owner/repo format"
        tests:
          - unique
          - not_null
      - name: owner
        description: "Repository owner (GitHub user or organization)"
        tests:
          - not_null
      - name: primary_language
        description: "Primary programming language of the repository"
      - name: created_at
        description: "Timestamp when the repository was created on GitHub"
      - name: visibility
        description: "Repository visibility setting"
        tests:
          - accepted_values:
              values: ['public', 'private']
      - name: is_fork
        description: "Boolean flag indicating whether the repository is a fork"
        tests:
          - not_null
      - name: stargazers_count
        description: "Number of stars on the repository"

  - name: fct_commits
    description: "Fact table with one row per commit. Joins to dim_repository and dim_date for analytical slicing. Materialized incrementally using merge on commit_sha."
    columns:
      - name: commit_sha
        description: "Unique commit SHA hash — primary key"
        tests:
          - unique
          - not_null
      - name: repo_id
        description: "Foreign key to dim_repository"
        tests:
          - not_null
          - relationships:
              to: ref('dim_repository')
              field: repo_id
      - name: date_key
        description: "Foreign key to dim_date based on commit date"
        tests:
          - relationships:
              to: ref('dim_date')
              field: date_key
      - name: committed_at
        description: "Timestamp when the commit was authored"
        tests:
          - not_null
      - name: hour_of_day
        description: "Hour of day (0-23) when the commit was made"
      - name: day_of_week
        description: "Day of week (1=Sunday, 7=Saturday) when the commit was made"
      - name: author_name
        description: "Name of the commit author"
      - name: author_email
        description: "Email of the commit author"
      - name: message_first_line
        description: "First 100 characters of the commit message"
      - name: additions
        description: "Number of lines added in this commit"
      - name: deletions
        description: "Number of lines deleted in this commit"
      - name: changed_files
        description: "Number of files changed in this commit"
      - name: total_changes
        description: "Total lines changed (additions + deletions)"

  - name: fct_pull_requests
    description: "Fact table with one row per pull request. Joins to dim_repository and dim_date for both created and merged dates. Materialized incrementally using merge on pr_key."
    columns:
      - name: pr_key
        description: "Surrogate key composed of repo_full_name#pr_number"
        tests:
          - unique
          - not_null
      - name: repo_id
        description: "Foreign key to dim_repository"
        tests:
          - not_null
          - relationships:
              to: ref('dim_repository')
              field: repo_id
      - name: pr_number
        description: "Pull request number within the repository"
        tests:
          - not_null
      - name: title
        description: "Pull request title"
      - name: state
        description: "Normalized PR state"
        tests:
          - not_null
          - accepted_values:
              values: ['open', 'closed', 'merged']
      - name: is_merged
        description: "Boolean flag indicating whether the PR has been merged"
        tests:
          - not_null
      - name: created_at
        description: "Timestamp when the PR was created"
        tests:
          - not_null
      - name: created_date_key
        description: "Foreign key to dim_date for the PR creation date"
        tests:
          - relationships:
              to: ref('dim_date')
              field: date_key
      - name: merged_at
        description: "Timestamp when the PR was merged (null if not merged)"
      - name: merged_date_key
        description: "Foreign key to dim_date for the PR merge date (null if not merged)"
        tests:
          - relationships:
              to: ref('dim_date')
              field: date_key
      - name: time_to_merge_hours
        description: "Hours elapsed between PR creation and merge (null if not merged)"
      - name: user_login
        description: "GitHub login of the PR author"

  - name: fct_reviews
    description: "Fact table with one row per pull request review. Joins to dim_repository, fct_pull_requests, and dim_date. Materialized incrementally using merge on review_id."
    columns:
      - name: review_id
        description: "Unique review identifier — primary key"
        tests:
          - unique
          - not_null
      - name: repo_id
        description: "Foreign key to dim_repository"
        tests:
          - not_null
          - relationships:
              to: ref('dim_repository')
              field: repo_id
      - name: pr_key
        description: "Foreign key to fct_pull_requests"
        tests:
          - not_null
          - relationships:
              to: ref('fct_pull_requests')
              field: pr_key
      - name: reviewer_login
        description: "GitHub login of the reviewer"
      - name: review_state
        description: "Review decision state"
        tests:
          - not_null
          - accepted_values:
              values: ['APPROVED', 'CHANGES_REQUESTED', 'COMMENTED', 'DISMISSED']
      - name: submitted_at
        description: "Timestamp when the review was submitted"
        tests:
          - not_null
      - name: date_key
        description: "Foreign key to dim_date based on review submission date"
        tests:
          - relationships:
              to: ref('dim_date')
              field: date_key

  - name: agg_daily_activity
    description: "Daily activity rollup with one row per calendar date. LEFT JOINs from dim_date ensure all dates appear, including zero-activity days. Includes rolling commit windows and streak calculations. Optimized for Metabase time-series dashboards."
    columns:
      - name: full_date
        description: "Calendar date"
        tests:
          - unique
          - not_null
      - name: date_key
        description: "Surrogate key in YYYYMMDD format, foreign key to dim_date"
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('dim_date')
              field: date_key
      - name: day_of_week
        description: "Day of week (1=Sunday, 7=Saturday)"
        tests:
          - not_null
      - name: day_name
        description: "Full name of the day (e.g., Monday)"
        tests:
          - not_null
      - name: iso_week_number
        description: "ISO week number of the year"
        tests:
          - not_null
      - name: month_number
        description: "Month number (1-12)"
        tests:
          - not_null
      - name: year
        description: "Calendar year"
        tests:
          - not_null
      - name: is_weekend
        description: "Boolean flag for weekend days"
        tests:
          - not_null
      - name: commit_count
        description: "Number of commits on this date"
        tests:
          - not_null
      - name: pr_opened_count
        description: "Number of pull requests opened on this date"
        tests:
          - not_null
      - name: pr_merged_count
        description: "Number of pull requests merged on this date"
        tests:
          - not_null
      - name: review_count
        description: "Number of PR reviews submitted on this date"
        tests:
          - not_null
      - name: total_additions
        description: "Total lines added across all commits on this date"
        tests:
          - not_null
      - name: total_deletions
        description: "Total lines deleted across all commits on this date"
        tests:
          - not_null
      - name: total_files_changed
        description: "Total files changed across all commits on this date"
        tests:
          - not_null
      - name: active_repo_count
        description: "Count of distinct repositories with any activity (commits, PRs, reviews) on this date"
        tests:
          - not_null
      - name: rolling_7d_commits
        description: "Sum of commits over the trailing 7-day window (current day + 6 preceding)"
        tests:
          - not_null
      - name: rolling_30d_commits
        description: "Sum of commits over the trailing 30-day window (current day + 29 preceding)"
        tests:
          - not_null
      - name: current_streak_days
        description: "Number of consecutive days with at least one commit, counting backwards from this date. Zero if no commits on this date."
        tests:
          - not_null

  - name: agg_weekly_activity
    description: "Weekly activity rollup with one row per ISO week. Includes all calendar weeks up to the current date, with zero-filled weeks for periods without activity. Provides week-over-week change metrics for trend analysis."
    columns:
      - name: year
        description: "Calendar year"
        tests:
          - not_null
      - name: iso_week_number
        description: "ISO week number (1-53)"
        tests:
          - not_null
      - name: week_start_date
        description: "First date of the ISO week"
        tests:
          - not_null
      - name: commit_count
        description: "Total commits during this week"
        tests:
          - not_null
      - name: pr_opened_count
        description: "Total pull requests opened during this week"
        tests:
          - not_null
      - name: pr_merged_count
        description: "Total pull requests merged during this week"
        tests:
          - not_null
      - name: review_count
        description: "Total PR reviews submitted during this week"
        tests:
          - not_null
      - name: total_additions
        description: "Total lines added across all commits this week"
        tests:
          - not_null
      - name: total_deletions
        description: "Total lines deleted across all commits this week"
        tests:
          - not_null
      - name: total_files_changed
        description: "Total files changed across all commits this week"
        tests:
          - not_null
      - name: active_repo_count
        description: "Count of distinct repositories with activity this week"
        tests:
          - not_null
      - name: week_over_week_commit_change
        description: "Percentage change in commit count compared to the previous week. NULL for the first week."

  - name: agg_monthly_activity
    description: "Monthly activity rollup with one row per calendar month. Includes all months up to the current date with zero-filled months. Provides month-over-month change and average daily commit metrics."
    columns:
      - name: year
        description: "Calendar year"
        tests:
          - not_null
      - name: month_number
        description: "Month number (1-12)"
        tests:
          - not_null
      - name: month_name
        description: "Full name of the month (e.g., January)"
        tests:
          - not_null
      - name: commit_count
        description: "Total commits during this month"
        tests:
          - not_null
      - name: pr_opened_count
        description: "Total pull requests opened during this month"
        tests:
          - not_null
      - name: pr_merged_count
        description: "Total pull requests merged during this month"
        tests:
          - not_null
      - name: review_count
        description: "Total PR reviews submitted during this month"
        tests:
          - not_null
      - name: total_additions
        description: "Total lines added across all commits this month"
        tests:
          - not_null
      - name: total_deletions
        description: "Total lines deleted across all commits this month"
        tests:
          - not_null
      - name: total_files_changed
        description: "Total files changed across all commits this month"
        tests:
          - not_null
      - name: active_repo_count
        description: "Count of distinct repositories with activity this month"
        tests:
          - not_null
      - name: month_over_month_commit_change
        description: "Percentage change in commit count compared to the previous month. NULL for the first month."
      - name: avg_daily_commits
        description: "Average number of commits per day within this month"
        tests:
          - not_null

  - name: agg_hourly_heatmap
    description: "Commit activity heatmap with one row per (day_of_week, hour_of_day) combination — exactly 168 rows. Designed for Metabase heatmap visualization of coding patterns."
    columns:
      - name: day_of_week
        description: "Day of week (1=Sunday, 7=Saturday)"
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7]
      - name: day_name
        description: "Full name of the day (e.g., Monday)"
        tests:
          - not_null
      - name: hour_of_day
        description: "Hour of day (0-23)"
        tests:
          - not_null
      - name: total_commits
        description: "Total number of commits in this day-hour slot across all time"
        tests:
          - not_null
      - name: avg_commits_per_week
        description: "Average commits per week for this day-hour slot"
        tests:
          - not_null
      - name: max_single_day_commits
        description: "Maximum number of commits in a single calendar day for this day-hour slot"
        tests:
          - not_null

  - name: agg_language_usage
    description: "Language usage metrics with one row per (language, month). Tracks commit activity and byte counts by primary programming language. Supports the Language Analytics dashboard in Metabase."
    columns:
      - name: year
        description: "Calendar year"
        tests:
          - not_null
      - name: month_number
        description: "Month number (1-12)"
        tests:
          - not_null
      - name: language
        description: "Primary programming language"
        tests:
          - not_null
      - name: total_bytes
        description: "Total bytes of code in this language across all active repositories"
        tests:
          - not_null
      - name: repo_count
        description: "Number of distinct repositories with this primary language that had commits"
        tests:
          - not_null
      - name: commit_count
        description: "Number of commits to repositories where this is the primary language"
        tests:
          - not_null
      - name: percentage_of_total_bytes
        description: "This language's byte count as a percentage of total bytes across all languages for the month"

  - name: agg_repo_activity
    description: "Repository activity metrics with one row per (repo_full_name, month). Provides commit, PR, and contributor metrics enriched with repository metadata from dim_repository. Supports the Repository Focus dashboard."
    columns:
      - name: repo_full_name
        description: "Full repository name in owner/repo format"
        tests:
          - not_null
      - name: repo_name
        description: "Short repository name"
        tests:
          - not_null
      - name: primary_language
        description: "Primary programming language of the repository"
      - name: stargazers_count
        description: "Number of stars on the repository"
      - name: visibility
        description: "Repository visibility (public or private)"
      - name: is_fork
        description: "Whether the repository is a fork"
      - name: year
        description: "Calendar year"
        tests:
          - not_null
      - name: month_number
        description: "Month number (1-12)"
        tests:
          - not_null
      - name: commit_count
        description: "Number of commits in this repository during the month"
        tests:
          - not_null
      - name: pr_count
        description: "Number of pull requests opened in this repository during the month"
        tests:
          - not_null
      - name: additions
        description: "Total lines added in this repository during the month"
        tests:
          - not_null
      - name: deletions
        description: "Total lines deleted in this repository during the month"
        tests:
          - not_null
      - name: unique_contributors
        description: "Number of distinct commit authors in this repository during the month"
        tests:
          - not_null
